---
title: "Statistical Learning: Project Presentation"
author: "G. Dunlavey, W. Ren, A. Taqi"
output:
  beamer_presentation:
    theme: "AnnArbor"
    colortheme: "dolphin"
    fonttheme: "structurebold"
header-includes:
  - \newcommand{\R}{\mathbb{R}}
---

```{r setup, include=FALSE}
# setup chunks
knitr::opts_chunk$set(echo = F, fig.align = "center", warning = F, message = F, fig.height = 3, fig.width = 4.5)
# load libaries
library(knitr)
library(tidyverse)
library(grid)
library(gridExtra)
library(patchwork)
library(ISLR)
# load helper scripts
source(file = "R/wrangle.R")
source(file = "R/model.R")
source(file = "R/visualization.R")
source(file = "R/threshold.R")
# global parameters
bplot <- T
bloud <- F
bhead <- F
bimage <- T
```

```{r}
#=============================#
#       Import Datasets       #
#=============================#
# Load rookies datasets
pit_rkes <- wrangle_init(read_csv("data/rookie-pitcher.csv"))
pos_rkes <- wrangle_init(read_csv("data/rookie-position.csv"))
# Load retirees datasets
pit_ret <- wrangle_init(read_csv("data/retirees-pitcher.csv"))
pos_ret <- wrangle_init(read_csv("data/retirees-position.csv"))
# Find number of retirees by year
num_retirees <- total_retirees_by_yr(pit_ret, pos_ret)
num_retirees <- data.frame(retirees = num_retirees$retirees)
```

```{r}
couldabeens <- read_csv(file = "data-gen/couldabeens.csv")
```


# Research Question

The MLB's "luxury tax," implemented in the 2003 Collective Bargaining Agreement, is a rule penalizing franchises whose team payroll for a given year exceeds an agreed threshold. This project attempts to test the tax's effect on quality of play by studying the number of above-rookie retirees (referred to here as "couldabeens") as a share of total retirements.

# Why does the luxury tax matter?

Although originally pitched as a way to "even the playing field," the luxury tax has increasingly functioned as a salary cap. Existing literature has established a continuing decline in labor share in the MLB since the 2003 CBA (Bradbury, 2019).

\[
Labor \: Share = \frac{Total \: MLB \: Revenue}{Total \: MLB \: Player \: Payroll}
\]

::: columns
:::: column
```{r, out.width = "100%"}
if(bimage){include_graphics("images/laborshare1.png")}
```
::::
:::: column
```{r, out.width = "100%"}
if(bimage){include_graphics("images/laborshare2.jpg")}
```
::::
:::

# Theory

How might the "luxury tax" increase the number of above-rookie retirees?

- Players don't gain free agency until six years of MLB service time, making rookies cheaper than veterans.
- Farm teams not counted towards salary threshold, guaranteeing reserve pool of rookies.
- Teams direct limited budget towards retaining a handful of elite veterans, filling out roster with rookies.
- Hypothesis: Good-but-not-Mike-Trout veterans replaced with marginally inferior rookies to stay below salary threshold.

# Methods: The Data

We got our data from https://stathead.com/baseball/ and divided it into four data sets:

1. Rookie pitchers
2. Rookie position players
3. Retired pitchers
4. Retired position players

# Methods: WAR

Wins Above Replacement, or WAR, is a baseball statistic which seeks to measure a player's total contribution to his team. A WAR of 0.3 means the player's team will win 0.3 more games per season than if he had been substituted for a replacement-level player.

Position WAR:
\[
WAR = \frac{(Player \: Runs - Average \: Runs) + (Average \: Runs - Replacement \:Runs)}{Game \: Runs \: to \: Wins \: Estimator}
\]

where

\[
Player \: Runs = Batting \: Runs + Baserunning \: Runs + Double \: Play \: Runs + Fielding \: Runs + Positional \: Adjustment
\]

Pitcher WAR:

\[
WAR = \frac{(Adjusted \: Average \: Runs \: Allowed - Adjusted \: Player \: Runs \: Allowed) + (Adjusted \: Replacement \:Runs \: Allowed - Adjusted \: Average \: Runs \: Allowed)}{Game \: Runs \: to \: Wins \: Estimator}
\]

However, the "replacement-level player" used in WAR is an estimate for the average *midseason* replacement. Being better than a midseason replacement does not necessarily make you better than the generation of rookies *actually* replacing you.

# Methods: The Couldabeen Classifier

We want to calculate whether a given retiring player is better than the average rookie replacing him. For a given year $Y$, we first compute the mean rookie's WAR, call it $Rookie_Y$. Then, we construct the corresponding classifier for "couldabeen" status $C$ of a given retired player $p$ (from the year $Y$) to be as follows:
\[
C(p) = \begin{cases}
True, \,  \text{WAR}_p \geq Rookie_Y \\
False, \, \text{WAR}_p < Rookie_Y 
\end{cases}
\]

# Visualization: Couldabeen Classification

```{r, fig.height = 3}
# Set colors
col1 <- "salmon"   # Retirees
col2 <- "skyblue3" # Rookies
# Set color parameters
colors_density <- c("Retirees" = col1, "Rookies" = col2)
# Density plot of rookie and retired pitchers 
pitcher_density <- ggplot() +
  geom_density(data = pit_ret, aes(x = WAR, color = "Retirees")) +
  geom_density(data = pit_rkes, aes(x = WAR, color = "Rookies")) +
  labs(title = "Pitchers") +
  theme(legend.position = 'right') +
  scale_color_manual("Player",values = colors_density) 
# Density plot of rookie position players and retired position players 
position_density <- ggplot() +
  geom_density(data = pos_ret, aes(x = WAR, color = "Retirees")) +
  geom_density(data = pos_rkes, aes(x = WAR, color = "Rookies")) +
  labs(title = "Position") +
  theme(legend.position = 'right') +
  scale_color_manual("Player",values = colors_density) 
# Plot
if(bplot){grid.arrange(pitcher_density, position_density, nrow = 2)}
```


# (No Partition)



# A Confounding Variable: *Moneyball* and the Sabermetric Revolution

\begin{quote}
"Sabermetrics is the search for objective knowledge about baseball through analysis of the statistical record." - from the Society for American Baseball Research, or SABR
\end{quote}

Timeline:

(1977) Bill James, inventor of term "sabermetrics," publishes first "book": *1977 Baseball Abstract*. It sells 75 copies.

(1997) Billy Beane promoted to general manager of Oakland Athletics. He's ready every *Baseball Abstract* ever published.

(October 2002) Athletics finish season with MLB's best record and second-lowest budget.

(November 2002) Beane declines $12.5 million offer from Boston Red Sox. Boston hires Bill James instead.

(June 2003) Michael Lewis publishes *Moneyball: The Art of Winning an Unfair Game*.

(October 2004) Boston wins their first World Series since 1918.

(2006) *Time* lists Bill James among "100 Most Influential People in the World." Nearly every MLB franchise employs a sabermetrics team.

\begin{quote}
"[Presidential politics] reminded me of baseball, when you see the same recycled clichés and conventional wisdoms over and over again, some of which isn’t very wise." - Former *Baseball Prospectus* partner Nate Silver, on why he founded *538*
\end{quote}

# Methods: Modeling

 **Linear Model:** After classifying all retired players, get proportion of "couldbaeen" retirees and call this `prop`.
 
- As such, we now have $50$ data points (for each year), so we run a linear model fitting `Year ~ prop`.
- Because there will always be "couldabeens", we do not expect a large effect size and hence a very significant result.
- If our research hypothesis is correct (that there is an effect), we expect to see a positive coefficient for $\beta_{Year}$.

# Linear Model: Couldabeens Retirees (Pre-rule Era: 1969-2002)

```{r}
# Partition dataset into years before and after rule
couldabeens_pre <- prerule(couldabeens)
couldabeens_post <- postrule(couldabeens)
```


```{r, fig.width = 4, fig.height = 2.75}
# Obtain linear model for pre-rule years
model_pre <- lm(formula = prop ~ I(Year), data = couldabeens_pre)
coefs_pre <- model_pre$coefficients
# Plot proportion of couldabeens in pre-rule era ()
plot_props_linear(couldabeens_pre, coefs_pre, 
                  color = "salmon", title = "Proportion of Couldabeen Retirees")
```

# Linear Model: Couldabeens Retirees (Post-rule Era: 2003-2018)

```{r, fig.width = 4, fig.height = 2.75}
# Obtain linear model for post-rule years
model_post <- lm(formula = prop ~ I(Year), data = couldabeens_post)
coefs_post <- model_post$coefficients
# Plot proportion of couldabeens in post-rule era ()
plot_props_linear(couldabeens_post, coefs_post, 
                  color = "skyblue2", title = "Proportion of Couldabeen Retirees")
```

# Overall Results: Linear Models

**Post-rule era** 

- Post-rule era model: $\beta_{Year} = 0.002064$. As such, since $\beta_{Year} > 0$. 
- There is evidence that the rule has lead to an increase in the proportion of couldabeens. 

**Pre-rule era** 

- Pre-rule era, we obtained a parameter $\beta_{Year} = 0.005773$.  As such, we also have $\beta_{Year} > 0$. 
- Conclude that up until the rule has been implemented, the proportion of couldabeens has been rising, and it rapidly drops in 2003 (year of the rule) only to increase again.

# Simpson's Paradox

- We chose to partition the dataset into the post-rule and pre-rule eras and fit a linear model `Year ~ prop`.
- In both partitions, we find that the parameter $\beta_{Year} > 0$. 
- However, if we do not make the partition, we find that $\beta_{Year} \approx 0$. 
- This raises some questions regarding the role our partition plays in our inference and modeling choices. 
- In fact, this is *Simpson's Paradox*.

```{r, echo = F}
# Obtain linear model for all years
model_comp <- lm(formula = prop ~ I(Year), data = couldabeens)
coefs_comp <- model_comp$coefficients
```

# Simpson's Paradox

```{r, fig.height = 2.75}
col <- "mediumvioletred"
col1 <- "salmon"
col2 <- "skyblue2"
# Plot proportion of couldabeens in post-rule era ()
scatter_props(couldabeens, title = "Proportion of Couldabeen Retirees") +
    geom_abline(slope = coefs_comp[2], intercept = coefs_comp[1], color = col) + 
    geom_point(data = couldabeens_pre, mapping = aes(x = Year, y = prop), color = col1) +
    geom_abline(slope = coefs_pre[2], intercept = coefs_pre[1], color = col1) +
    geom_point(data = couldabeens_post, mapping = aes(x = Year, y = prop),color = col2) +
    geom_abline(slope = coefs_post[2], intercept = coefs_post[1], color = col2) + 
    labs(y = "Proportion")
```

# Threshold Stability

Recall the definition of the Couldabeen classifier: 

## The General Couldabeen Classifier

Given a threshold $t \in \mathbb{R}$, we construct the corrosponding classifier for "couldabeen" status $C$ of a given retired player $p$ (from the year $Y$) to be as follows:
\[
C(p) = \begin{cases}
True, \,  \text{WAR}_p \geq \mu_Y + t\sigma_Y \\
False, \, \text{WAR}_p < \mu_Y + t\sigma_Y
\end{cases}
\]

# Threshold Stability

- Analyze the effects of the threshold $t$ on the impact of our $\beta_{\text{Year}}$ fitting the linear models. 
- Our inference relies on $\beta_{\text{Year}}$ being positive for any $t \in \R$. 
- Obtained a supporting result for $\beta_{Year}$ for only a particular threshold ($t = 0$) in the post-rule era. 
- Varying the threshold tells another story.
- Run a linear model with `Year ~ prop` against a varying threshold $t \in \mathbb{R}$.
- Found that $\beta_{Year}$ is quite unstable.

# Threshold Stability

```{r, out.width= "80%", fig.cap = "Parameters of the Linear Model against varying threshold for couldabeen status"}
include_graphics("images/coef.jpeg")
```

# Threshold Stability: Possible Adjustments

- Thresholds every year were calculated as a function of *only* that year's data. 
- So, the sample from which we obtain the threshold by each level (corrosponding to each year) is very small meaning small changes to the threshold cause high levels of noise in our final model. 
- To treat this problem, we may consider "smoothing" the threshold out by taking the data of that year and adjacent years. 
For instance, instead of considering just 2018 data, we may take 2017-2019 data for a "window length of 1". 
- Furthermore, the addition of some supplementary yearly salary/budgets data may be useful as another predictor since `Year` alone does not seem to have good explanatory power.

# Conclusion

To summarize:
- No correlation between year and proportion of couldabeens across entire 50-year span.
- Positive but non-significant relationship between year and proportion of couldabeens when partitioned into pre- and post-*Moneyball* eras.
- Strongly significant negative relationship between publication of *Moneyball* and proportion of couldabeens.
- Somewhat significant relationship between labor share and proportion of couldabeens in post-*Moneyball* era.

# References

(1) https://stathead.com/baseball/
(2) Bradbury, John Charles. “What Explains Labor's Declining Share of Revenue in Major League Baseball?” (2019).
(3) https://blogs.fangraphs.com/mlbs-evolving-luxury-tax/


